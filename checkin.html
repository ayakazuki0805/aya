<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é–€é™ãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body {
      font-family: "Yu Gothic UI", sans-serif;
      margin: 2em;
      background: #f7f7f7;
      color: #333;
    }
    h2 {
      margin-top: 1.5em;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      max-width: 300px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover {
      background-color: #45a049;
    }
    /* â–¼ ç®¡ç†è€…ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  â–¼ */
    button.admin-button {
      background-color: #f44336; /* é•ã†è‰²ã«ã™ã‚‹ */
    }
    button.admin-button:hover {
      background-color: #d32f2f;
    }
    /* â–² ã“ã“ã¾ã§ â–² */
    #status {
      margin-top: 1em;
      font-weight: bold;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ‘¤ æ–°è¦ç™»éŒ²</h2>
    <input id="reg_name" placeholder="åå‰">
    <input id="reg_email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input id="reg_password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="register()">ç™»éŒ²</button>

    <h2>ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <input id="log_email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input id="log_password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>

    <h2>ğŸ“ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
    <button onclick="checkin()">ç¾åœ¨åœ°ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>
    <p id="status"></p>

    <h2>ğŸ”’ ç®¡ç†è€…</h2>
    <button onclick="viewAdminLogs()" class="admin-button">ç®¡ç†è€…ãƒ­ã‚°ã‚’è¡¨ç¤º</button>
    </div>

  <script>
    const API_BASE = ""; // â† ã“ã‚Œã«å¤‰æ›´ (åŒã˜ã‚µãƒ¼ãƒãƒ¼ã¨ã„ã†æ„å‘³)    
    const DEVICE_ID_KEY = "device_id";
    const TOKEN_KEY = "jwt_token";

    // (getDeviceId, register, login, checkin é–¢æ•°ã¯ãã®ã¾ã¾)
    // ...
    function getDeviceId() {
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if (!id) {
        id = "device-" + Math.random().toString(36).substring(2, 12);
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    }
    async function register() {
      const name = document.getElementById("reg_name").value.trim();
      const email = document.getElementById("reg_email").value.trim();
      const password = document.getElementById("reg_password").value;
      const device_id = getDeviceId();
      if (!name || !email || !password) {
        alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const res = await fetch(`${API_BASE}/register`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name, email, password, device_id})
      });
      const data = await res.json();
      if (res.ok) alert("ç™»éŒ²å®Œäº†ï¼");
      else alert("ç™»éŒ²å¤±æ•—: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
    }
    async function login() {
      const email = document.getElementById("log_email").value.trim();
      const password = document.getElementById("log_password").value;
      const res = await fetch(`${API_BASE}/login`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({email, password})
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem(TOKEN_KEY, data.token);
        console.log("DEBUG: [Login] ä¿å­˜ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³:", data.token);
        alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼");
      } else {
        alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (data.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
      }
    }
    async function checkin() {
      const token = localStorage.getItem(TOKEN_KEY);
      const device_id = getDeviceId();
      console.log("DEBUG: [Checkin] é€ä¿¡ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³:", token);
      console.log("DEBUG: [Checkin] é€ä¿¡ã™ã‚‹DeviceID:", device_id);
      if (!token) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      document.getElementById("status").innerText = "ä½ç½®æƒ…å ±å–å¾—ä¸­...";
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const res = await fetch(`${API_BASE}/checkin`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
            "X-Device-ID": device_id
          },
          body: JSON.stringify({latitude: lat, longitude: lon})
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById("status").innerText =
            `âœ… ${data.user} ã•ã‚“ã®çµæœ: ${data.status}\nè·é›¢: ${data.distance_km}km\n(${data.server_time})`;
        } else {
          document.getElementById("status").innerText = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`;
        }
      }, (err) => {
        document.getElementById("status").innerText = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“: " + err.message;
      });
    }
    // ...

    // â–¼â–¼â–¼ ç®¡ç†è€…ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’æ–°ã—ãè¿½åŠ  â–¼â–¼â–¼
    async function viewAdminLogs() {
      const token = localStorage.getItem(TOKEN_KEY);
      if (!token) {
        alert("ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã¦ /admin_logs ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const res = await fetch(`${API_BASE}/admin_logs`, {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      if (res.ok) {
        // æˆåŠŸã—ãŸå ´åˆ (HTMLãŒè¿”ã£ã¦ãã‚‹)
        const html = await res.text();
        // æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦ã€ãã®ã‚¿ãƒ–ã«HTMLã‚’æ›¸ãè¾¼ã‚€
        const logWindow = window.open("", "_blank");
        logWindow.document.write(html);
        logWindow.document.close();
      } else {
        // å¤±æ•—ã—ãŸå ´åˆ (401: èªè¨¼ã‚¨ãƒ©ãƒ¼, 403: æ¨©é™ã‚¨ãƒ©ãƒ¼ãªã©)
        const errorMessage = await res.text(); // "èªè¨¼ã‚¨ãƒ©ãƒ¼" ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆ
        alert("ãƒ­ã‚°å–å¾—å¤±æ•—: " + errorMessage);
      }
    }
    // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
  </script>
</body>
</html>